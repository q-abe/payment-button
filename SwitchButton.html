<script>
    const targetOfParentQuery = ".form.aem-GridColumn--tablet--10.aem-GridColumn--phone--none.aem-GridColumn--tablet--none.aem-GridColumn--phone--10.aem-GridColumn.aem-GridColumn--offset--phone--1.aem-GridColumn--default--5.aem-GridColumn--offset--tablet--1 bat-form-cashondeliverypayment";

    const creditRadioQuery = ".bat-form-field.bat-form--cashondelivery-payment-credit-card-header input[name='creditCardHeader']";
    const cashRadioQuery = ".cashondelivery-method-section input[name='creditCardHeader']";
    const creditButtonQuery = ".bat-form-field.bat-form--cashondelivery-payment-submit button[class='bat-cta-style button-secondary-dark']";
    const cashButtonQuery = ".confirm-order-button-block a[class='bat-cta-style button-secondary-dark center disabled']";

    const addButton = `<div><button class="copiedPaymentButton disabled" id="initialButton">初期値ボタン</button></div><div><button class="copiedPaymentButton disabled hidden" id="copiedCredit">クレジット決済</button></div><div><button class="copiedPaymentButton disabled hidden" id="copiedCash">代引き決済</button></div>`;
    const justBeforeQuery = "#cashondeliveryForm";

    const copiedCreditQuery = "#copiedCredit";
    const copiedCashQuery = "#copiedCash";
    const initialButtonQuery = "#initialButton";

    const hasNodeObserver = () => {
        const hasNode = {
            creditRadioNode: false,
            creditButtonNode: false,
            cashRadioNode: false,
            cashButtonNode: false
        };
        const domObserver = new MutationObserver(mutations => {
            const checkNodeRendered = (mutation, query, prop) => {
                if (mutation.target.querySelector(query)) {
                    hasNode[prop] = true;
                    console.log(`${prop} rendered`);
                }
            };
            mutations.forEach(mutation => {
                checkNodeRendered(mutation, creditRadioQuery, "creditRadioNode");
                checkNodeRendered(mutation, creditButtonQuery, "creditButtonNode");
                checkNodeRendered(mutation, cashRadioQuery, "cashRadioNode");
                checkNodeRendered(mutation, cashButtonQuery, "cashButtonNode");
            });
            if (Object.values(hasNode).every(count => count)) {
                console.log("all targets rendered");
                domObserver.disconnect();
                addElementsFn(justBeforeQuery, "afterend", addButton);
                afterLoadingFn();
            }
        });
        const targetOfParent = document.querySelector(targetOfParentQuery);
        domObserver.observe(targetOfParent, {
            childList: true,
            subtree: true
        });
    };

    hasNodeObserver();


    const addElementsFn = (query, position, element) => {
        const addTarget = document.querySelector(query);
        addTarget.insertAdjacentHTML(position, element);
        console.log(`Element is added at the ${position}`);
    };

    const afterLoadingFn = () => {
        const copiedCredit = document.querySelector(copiedCreditQuery);
        const copiedCash = document.querySelector(copiedCashQuery);
        const initialButton = document.querySelector(initialButtonQuery)

        const creditRadio = document.querySelector(creditRadioQuery);
        const cashRadio = document.querySelector(cashRadioQuery);
        const creditOriginButton = document.querySelector(creditButtonQuery);
        const cashOriginButton = document.querySelector(cashButtonQuery);

        if (copiedCredit && copiedCash && initialButton) {
            /**
             *支払いをクレジットにしたとき、代引きの購入確定ボタンを非表示にする
             */
            creditRadio.addEventListener("change", () => {
                copiedCredit.classList.remove("hidden");
                copiedCash.classList.add("hidden");
                initialButton.classList.add("hidden");
                console.log("switch to creditButton");
            });

            //支払いを代引きにしたとき、クレジットの購入確定ボタンを非表示にする
            cashRadio.addEventListener("change", () => {
                copiedCredit.classList.add("hidden");
                copiedCash.classList.remove("hidden");
                initialButton.classList.add("hidden");
                console.log("switch to cashButton");
            });

            //クレジットの購入ボタンをクリックしたとき、オリジナルボタンをクリックする
            copiedCredit.addEventListener("click", () => {
                const clickEvent = new Event("click");
                creditOriginButton.dispatchEvent(clickEvent);
                console.log("credit settlement");
            });

            //代引きの購入ボタンをクリックしたとき、オリジナルボタンをクリックする
            copiedCash.addEventListener("click", () => {
                const clickEvent = new Event("click");
                cashOriginButton.click();
                console.log("cash settlement");
            });

            //監視オブジェクトのインスタンス化
            const creditObserver = new MutationObserver(mutations => {
                mutations.forEach((record) => {
                    const disableValue = record.target.getAttribute("disabled");
                    //クレジットの購入ボタンが活性状態のとき、コピーボタンを活性状態にする
                    if (disableValue === "" || disableValue === "disabled") {
                        copiedCredit.classList.add("disabled");
                        console.log("creditButton disabled");
                    } else {
                        copiedCredit.classList.remove("disabled");
                        console.log("creditButton enabled");
                    }
                });
            });

            //監視オブジェクトによる監視開始(クレジット購入ボタンの属性の変化)
            creditObserver.observe(creditOriginButton, {
                attributes: true
            });

            //監視オブジェクトのインスタンス化
            const cashObserver = new MutationObserver(mutations => {
                mutations.forEach((record) => {
                    //代引きの購入ボタンが活性状態のとき、コピーボタンを活性状態にする
                    if (record.target.classList.contains("disabled")) {
                        copiedCash.classList.add("disabled");
                        console.log("cashButton disabled");
                    } else {
                        copiedCash.classList.remove("disabled");
                        console.log("cashButton enabled");
                    }
                });
            });

            //監視オブジェクトによる監視開始(代引き購入ボタンのクラス属性の変化)
            cashObserver.observe(cashOriginButton, {
                attributes: true,
                attributeFilter: ["class"]
            });
        } else {
            console.log("変数ないよ");
        }
    };
</script>

<style>
  button.copiedPaymentButton.disabled {
    pointer-events: none;
    background-color: #ccc;
    color: #aaa;
  }

  div.bat-form-field.bat-form--cashondelivery-payment-submit {
    display: none;
  }

  a.bat-cta-style.button-secondary-dark.center {
    display: none;
  }

  a.bat-cta-style.button-secondary-dark.center.disabled {
    pointer-events: none;
    background: #dedede;
    cursor: not-allowed;
    opacity: 1;
    color: #aaa;
    display: none;
  }

  button.copiedPaymentButton.hidden {
    display: none;
  }

  button.copiedPaymentButton {
    background-color: #f5c342;
    border: 0;
    color: black;
    display: flex;

    justify-content: center;
    align-items: center;
    width: 100%;
    height: 45px;
    border-radius: 50px;
    font: inherit;
    font-weight: bold;
  }
</style>

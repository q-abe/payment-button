<script>
    const target = document.querySelector(".form.aem-GridColumn--tablet--10.aem-GridColumn--phone--none.aem-GridColumn--tablet--none.aem-GridColumn--phone--10.aem-GridColumn.aem-GridColumn--offset--phone--1.aem-GridColumn--default--5.aem-GridColumn--offset--tablet--1 bat-form-cashondeliverypayment");
    const countObj = {
        creditRadioNode: false,
        creditButtonNode: false,
        cashRadioNode: false,
        cashButtonNode: false
    };

    const domObserver = new MutationObserver(mutations => {
        mutations.forEach(mutation => {
            if (mutation.target.querySelector(".bat-form-field.bat-form--cashondelivery-payment-credit-card-header input[name='creditCardHeader']")) {
                countObj.creditRadioNode = true;
                console.log("creditRadioNode rendered");
            }
            if (mutation.target.querySelector(".bat-form-field.bat-form--cashondelivery-payment-submit button[class='bat-cta-style button-secondary-dark']")) {
                countObj.creditButtonNode = true;
                console.log("creditButtonNode rendered");
            }
            if (mutation.target.querySelector(".cashondelivery-method-section input[name='creditCardHeader']")) {
                countObj.cashRadioNode = true;
                console.log("cashRadioNode rendered");
            }
            if (mutation.target.querySelector(".confirm-order-button-block a[class='bat-cta-style button-secondary-dark center disabled']")) {
                countObj.cashButtonNode = true;
                console.log("cashButtonNode rendered");
            }
        });

        if (Object.values(countObj).every(count => count)) {
            console.log("all targets rendered");
            domObserver.disconnect();
            addButtonFn();
            afterLoadingFn();
        }
    });

    domObserver.observe(target, {
        childList: true,
        subtree: true
    });

    const addButtonFn = () => {
        const addTarget = document.getElementById("cashondeliveryForm");
        const addButton = `
                <div>
                    <button class="clicker disabled" id="initialButton">初期値ボタン</button>
                </div>
                <div>
                    <button class="clicker disabled hidden" id="copiedCredit">クレジット決済</button>
                </div>
                <div>
                    <button class="clicker disabled hidden" id="copiedCash">代引き決済</button>
                </div>`;

        addTarget.insertAdjacentHTML("afterend", addButton);
        console.log("copyButton added");
    };

    const afterLoadingFn = () => {
        const copiedCredit = document.querySelector("#copiedCredit");
        const copiedCash = document.querySelector("#copiedCash");
        const initialButton = document.querySelector("#initialButton");

        const creditRadio = document.querySelector(".bat-form-field.bat-form--cashondelivery-payment-credit-card-header input[name='creditCardHeader']");
        const cashRadio = document.querySelector(".cashondelivery-method-section input[name='creditCardHeader']");
        const creditOriginButton = document.querySelector(".bat-form-field.bat-form--cashondelivery-payment-submit button[class='bat-cta-style button-secondary-dark']");
        const cashOriginButton = document.querySelector(".confirm-order-button-block a[class='bat-cta-style button-secondary-dark center disabled']");

        if (copiedCredit && copiedCash && initialButton) {
            /**
             *支払いをクレジットにしたとき、代引きの購入確定ボタンを非表示にする
             */
            creditRadio.addEventListener("change", () => {
                copiedCredit.classList.remove("hidden");
                copiedCash.classList.add("hidden");
                initialButton.classList.add("hidden");
                console.log("switch to creditButton");
            });

            //支払いを代引きにしたとき、クレジットの購入確定ボタンを非表示にする
            cashRadio.addEventListener("change", () => {
                copiedCredit.classList.add("hidden");
                copiedCash.classList.remove("hidden");
                initialButton.classList.add("hidden");
                console.log("switch to cashButton");
            });

            //クレジットの購入ボタンをクリックしたとき、オリジナルボタンをクリックする
            copiedCredit.addEventListener("click", () => {
                const clickEvent = new Event("click");
                creditOriginButton.dispatchEvent(clickEvent);
                console.log("credit settlement");
            });

            //代引きの購入ボタンをクリックしたとき、オリジナルボタンをクリックする
            copiedCash.addEventListener("click", () => {
                const clickEvent = new Event("click");
                cashOriginButton.click();
                console.log("cash settlement");
            });

            //監視オブジェクトのインスタンス化
            const creditObserver = new MutationObserver(mutations => {
                mutations.forEach((record) => {
                    const disableValue = record.target.getAttribute("disabled");
                    //クレジットの購入ボタンが活性状態のとき、コピーボタンを活性状態にする
                    if (disableValue === "" || disableValue === "disabled") {
                        copiedCredit.classList.add("disabled");
                        console.log("creditButton disabled");
                    } else {
                        copiedCredit.classList.remove("disabled");
                        console.log("creditButton enabled");
                    }
                });
            });

            //監視オブジェクトによる監視開始(クレジット購入ボタンの属性の変化)
            creditObserver.observe(creditOriginButton, {
                attributes: true
            });

            //監視オブジェクトのインスタンス化
            const cashObserver = new MutationObserver(mutations => {
                mutations.forEach((record) => {
                    //代引きの購入ボタンが活性状態のとき、コピーボタンを活性状態にする
                    if (record.target.classList.contains("disabled")) {
                        copiedCash.classList.add("disabled");
                        console.log("cashButton disabled");
                    } else {
                        copiedCash.classList.remove("disabled");
                        console.log("cashButton enabled");
                    }
                });
            });

            //監視オブジェクトによる監視開始(代引き購入ボタンのクラス属性の変化)
            cashObserver.observe(cashOriginButton, {
                attributes: true,
                attributeFilter: ["class"]
            });
        } else {
            console.log("変数ないよ");
        }
    };
</script>

<style>
    button.clicker.disabled {
        pointer-events: none;
        background-color: #ccc;
        color: #aaa;
        }

    div.bat-form-field.bat-form--cashondelivery-payment-submit {
        display: none;
        }

    a.bat-cta-style.button-secondary-dark.center {
        display: none;
        }

    a.bat-cta-style.button-secondary-dark.center.disabled {
        pointer-events: none;
        background: #dedede;
        cursor: not-allowed;
        opacity: 1;
        color: #aaa;
        display: none;
        }

    button.clicker.hidden {
        display: none;
        }

    button.clicker {
        background-color: #f5c342;
        border: 0;
        color: black;
        display: flex;

        justify-content: center;
        align-items: center;
        width: 100%;
        height: 45px;
        border-radius: 50px;
        font: inherit;
        font-weight: bold;
        }
</style>

<script>
    const TARGET_OF_PARENT_QUERY = ".form.aem-GridColumn--tablet--10.aem-GridColumn--phone--none.aem-GridColumn--tablet--none.aem-GridColumn--phone--10.aem-GridColumn.aem-GridColumn--offset--phone--1.aem-GridColumn--default--5.aem-GridColumn--offset--tablet--1 bat-form-cashondeliverypayment";

    const CREDIT_RADIO_QUERY = ".bat-form-field.bat-form--cashondelivery-payment-credit-card-header input[name='creditCardHeader']";
    const CASH_RADIO_QUERY = ".cashondelivery-method-section input[name='creditCardHeader']";
    const CREDIT_BUTTON_QUERY = ".bat-form-field.bat-form--cashondelivery-payment-submit button[class='bat-cta-style button-secondary-dark']";
    const CASH_BUTTON_QUERY = ".confirm-order-button-block a[class='bat-cta-style button-secondary-dark center disabled']";

    const COPY_BUTTON_NODE = `<div><button class="copiedPaymentButton disabled" id="initialButton">初期値ボタン</button></div><div><button class="copiedPaymentButton disabled hidden" id="copiedCredit">クレジット決済</button></div><div><button class="copiedPaymentButton disabled hidden" id="copiedCash">代引き決済</button></div>`;
    const ADD_BTN_JUST_BEFORE_QUERY = "#cashondeliveryForm";

    const HIDDEN_CLASS = "hidden";

    const copiedCreditQuery = "#copiedCredit";
    const copiedCashQuery = "#copiedCash";
    const initialButtonQuery = "#initialButton";

    /**
     *対象のNodeに変化が起きたらcallback関数を実行する。
     */
    const setChangeAction = (node, callback) => {
        node.addEventListener("change", callback);
    };

    /**
     *受け取ったプロパティによってHiddenを追加、削除する。
     */
    const setHiddenClass = (node, property) => {
        const isAdd = property === "add";
        isAdd ? node.classList.add(HIDDEN_CLASS)
            : node.classList.remove(HIDDEN_CLASS);
    };

    /**
     *受け取った追加や削除したい対象の配列を取り出す。
     */
    const toggleHiddenClasses = ({addNodes, removeNodes}) => {
        addNodes.forEach(addNode => {
            setHiddenClass(addNode, "add");
        });
        removeNodes.forEach(removeNode => {
            setHiddenClass(removeNode, "remove");
        });
    };

    const startObserveDomRendered = () => {
        const hasNode = {
            creditRadio: undefined,
            creditButton: undefined,
            cashRadio: undefined,
            cashButton: undefined
        };
        const queries = {
            creditRadio: CREDIT_RADIO_QUERY,
            creditButton: CREDIT_BUTTON_QUERY,
            cashRadio: CASH_RADIO_QUERY,
            cashButton: CASH_BUTTON_QUERY
        };

        const checkNodesRendered = (node) => {
            Object.keys(queries).forEach(queryKey => {
                if (node.target.querySelector(queries[queryKey])) {
                    hasNode[queryKey] = node.target.querySelector(queries[queryKey]);
                    console.log(`${queryKey}Node rendered`);
                }
            });
        };
        const hasAllNodes = () => {
            if (Object.values(hasNode).every(count => count)) {
                targetOfParentObserver.disconnect();
                console.log("observe disconnected");
                console.log("all targets rendered");
                addElementsFn(ADD_BTN_JUST_BEFORE_QUERY, "afterend", COPY_BUTTON_NODE);
                afterLoadingFn(hasNode);
            }
        };
        const targetOfParentObserver = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                checkNodesRendered(mutation);
            });
            hasAllNodes();
        });
        const targetOfParent = document.querySelector(TARGET_OF_PARENT_QUERY);
        targetOfParentObserver.observe(targetOfParent, {
            childList: true,
            subtree: true
        });
    };

    const addElementsFn = (query, position, element) => {
        const addTarget = document.querySelector(query);
        addTarget.insertAdjacentHTML(position, element);
        console.log(`Element is added at the ${position}`);
    };

    const afterLoadingFn = (hasNodes) => {
        const copiedCredit = document.querySelector(copiedCreditQuery);
        const copiedCash = document.querySelector(copiedCashQuery);
        const initialButton = document.querySelector(initialButtonQuery);

        if (copiedCredit && copiedCash && initialButton) {
            /**
             *支払いを選択したとき、非選択の購入確定ボタンを非表示にする
             */
            setChangeAction(hasNodes.creditRadio, () => {
                toggleHiddenClasses(
                    {
                        addNodes: [copiedCash, initialButton],
                        removeNodes: [copiedCredit]
                    }
                );
            });

            setChangeAction(hasNodes.cashRadio, () => {
                toggleHiddenClasses(
                    {
                        addNodes: [copiedCredit, initialButton],
                        removeNodes: [copiedCash]
                    }
                );
            });

            //クレジットの購入ボタンをクリックしたとき、オリジナルボタンをクリックする
            copiedCredit.addEventListener("click", () => {
                const clickEvent = new Event("click");
                hasNodes.creditButton.dispatchEvent(clickEvent);
                console.log("credit settlement");
            });

            //代引きの購入ボタンをクリックしたとき、オリジナルボタンをクリックする
            copiedCash.addEventListener("click", () => {
                const clickEvent = new Event("click");
                hasNodes.cashButton.click();
                console.log("cash settlement");
            });

            //監視オブジェクトのインスタンス化
            const creditObserver = new MutationObserver(mutations => {
                mutations.forEach((record) => {
                    const disableValue = record.target.getAttribute("disabled");
                    //クレジットの購入ボタンが活性状態のとき、コピーボタンを活性状態にする
                    if (disableValue === "" || disableValue === "disabled") {
                        copiedCredit.classList.add("disabled");
                        console.log("creditButton disabled");
                    } else {
                        copiedCredit.classList.remove("disabled");
                        console.log("creditButton enabled");
                    }
                });
            });

            //監視オブジェクトによる監視開始(クレジット購入ボタンの属性の変化)
            creditObserver.observe(hasNodes.creditButton, {
                attributes: true
            });

            //監視オブジェクトのインスタンス化
            const cashObserver = new MutationObserver(mutations => {
                mutations.forEach((record) => {
                    //代引きの購入ボタンが活性状態のとき、コピーボタンを活性状態にする
                    if (record.target.classList.contains("disabled")) {
                        copiedCash.classList.add("disabled");
                        console.log("cashButton disabled");
                    } else {
                        copiedCash.classList.remove("disabled");
                        console.log("cashButton enabled");
                    }
                });
            });

            //監視オブジェクトによる監視開始(代引き購入ボタンのクラス属性の変化)
            cashObserver.observe(hasNodes.cashButton, {
                attributes: true,
                attributeFilter: ["class"]
            });
        } else {
            console.log("変数ないよ");
        }
    };

    startObserveDomRendered();

</script>

<style>
  button.copiedPaymentButton.disabled {
    pointer-events: none;
    background-color: #ccc;
    color: #aaa;
  }

  div.bat-form-field.bat-form--cashondelivery-payment-submit {
    display: none;
  }

  a.bat-cta-style.button-secondary-dark.center {
    display: none;
  }

  a.bat-cta-style.button-secondary-dark.center.disabled {
    pointer-events: none;
    background: #dedede;
    cursor: not-allowed;
    opacity: 1;
    color: #aaa;
    display: none;
  }

  button.copiedPaymentButton.hidden {
    display: none;
  }

  button.copiedPaymentButton {
    background-color: #f5c342;
    border: 0;
    color: black;
    display: flex;

    justify-content: center;
    align-items: center;
    width: 100%;
    height: 45px;
    border-radius: 50px;
    font: inherit;
    font-weight: bold;
  }
</style>
